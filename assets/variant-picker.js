var P=r=>{throw TypeError(r)};var g=(r,d,e)=>d.has(r)||P("Cannot "+e);var u=(r,d,e)=>(g(r,d,"read from private field"),e?e.call(r):d.get(r)),w=(r,d,e)=>d.has(r)?P("Cannot add the same private member more than once"):d instanceof WeakSet?d.add(r):d.set(r,e),v=(r,d,e,t)=>(g(r,d,"write to private field"),t?t.call(r,e):d.set(r,e),e);import{C as O}from"./component.js";import{V as S,c as y}from"./events.js";import{m as k}from"./morph.js";import{B as C,C as b}from"./utilities.js";var f,h,I,E;class V extends O{constructor(){super(...arguments);w(this,f);w(this,h);w(this,I,[]);w(this,E,[])}connectedCallback(){super.connectedCallback(),(this.refs.fieldsets||[]).forEach(t=>{const n=Array.from(t?.querySelectorAll("input")??[]);u(this,E).push(n);const s=n.findIndex(i=>i.dataset.currentChecked==="true");s!==-1&&u(this,I).push([s])}),this.addEventListener("change",this.variantChanged.bind(this))}variantChanged(e){if(!(e.target instanceof HTMLElement))return;const t=e.target instanceof HTMLSelectElement?e.target.options[e.target.selectedIndex]:e.target;if(!t)return;this.updateSelectedOption(e.target),this.dispatchEvent(new S({id:t.dataset.optionValueId??""}));const n=this.dataset.templateProductMatch==="true"&&!e.target.closest("product-card")&&!e.target.closest("quick-add-dialog"),s=this.dataset.productUrl?.split("?")[0],i=t.dataset.connectedProductUrl,a=n&&!!i&&i!==s,o=!!this.closest("featured-product-information"),l=a?"main":o?"featured-product-information":void 0;this.fetchUpdatedSection(this.buildRequestUrl(t),l);const c=new URL(window.location.href),p=t.dataset.variantId||null;n&&(p?c.searchParams.set("variant",p):c.searchParams.delete("variant")),a&&(c.pathname=i),c.href!==window.location.href&&C(()=>{history.replaceState({},"",c.toString())})}updateSelectedOption(e){if(typeof e=="string"){const t=this.querySelector(`[data-option-value-id="${e}"]`);if(!t)throw new Error("Target element not found");e=t}if(e instanceof HTMLInputElement){const t=Number.parseInt(e.dataset.fieldsetIndex||""),n=Number.parseInt(e.dataset.inputIndex||"");if(!Number.isNaN(t)&&!Number.isNaN(n)){const i=(this.refs.fieldsets||[])[t],a=u(this,I)[t],o=u(this,E)[t];if(o&&a&&i){const[l,c]=a;l!==void 0&&o[l]&&(o[l].dataset.previousChecked="false"),c!==void 0&&o[c]&&(o[c].dataset.previousChecked="false"),a.unshift(n),a.length=Math.min(a.length,2);const p=a[0],m=a[1];p!==void 0&&o[p]&&(o[p].dataset.currentChecked="true",i.style.setProperty("--pill-width-current",`${o[p].parentElement?.offsetWidth||0}px`)),m!==void 0&&o[m]&&(o[m].dataset.previousChecked="true",o[m].dataset.currentChecked="false",i.style.setProperty("--pill-width-previous",`${o[m].parentElement?.offsetWidth||0}px`))}}e.checked=!0}if(e instanceof HTMLSelectElement){const t=e.value,n=Array.from(e.options).find(s=>s.value===t);if(!n)throw new Error("Option not found");for(const s of e.options)s.removeAttribute("selected");n.setAttribute("selected","selected")}}buildRequestUrl(e,t=null,n=[]){let s=e.dataset.connectedProductUrl||u(this,f)||this.dataset.productUrl;v(this,f,s);const i=[],a=b();a&&i.push(`view=${a}`),this.selectedOptionsValues.length&&!t?i.push(`option_values=${this.selectedOptionsValues.join(",")}`):t==="product-card"&&(this.selectedOptionsValues.length?i.push(`option_values=${n.join(",")}`):i.push(`option_values=${e.dataset.optionValueId}`));const o={"quick-add-component":"section-rendering-product-card","swatches-variant-picker-component":"section-rendering-product-card","featured-product-information":this.closest("featured-product-information")?.id},l=Object.keys(o).find(c=>this.closest(c));return l?(s?.includes("?")&&(s=s.split("?")[0]),`${s}?section_id=${o[l]}&${i.join("&")}`):`${s}?${i.join("&")}`}fetchUpdatedSection(e,t){u(this,h)?.abort(),v(this,h,new AbortController),fetch(e,{signal:u(this,h).signal}).then(n=>n.text()).then(n=>{v(this,f,void 0);const s=new DOMParser().parseFromString(n,"text/html");s.querySelector("overflow-list[defer]")?.removeAttribute("defer");const i=s.querySelector('variant-picker script[type="application/json"]')?.textContent;if(i)if(t==="main")this.updateMain(s);else if(t)this.updateElement(s,t);else{const a=this.updateVariantPicker(s);this.selectedOptionId&&this.dispatchEvent(new y(JSON.parse(i),this.selectedOptionId,{html:s,productId:this.dataset.productId??"",newProduct:a}))}}).catch(n=>{n.name==="AbortError"?console.warn("Fetch aborted by user"):console.error(n)})}updateVariantPicker(e){let t;const n=e.querySelector(this.tagName.toLowerCase());if(!n)throw new Error("No new variant picker source found");if(n instanceof HTMLElement){const s=n.dataset.productId,i=n.dataset.productUrl;s&&i&&this.dataset.productId!==s&&(t={id:s,url:i}),this.dataset.productId=s,this.dataset.productUrl=i}return k(this,n),t}updateElement(e,t){const n=this.closest(t),s=e.querySelector(t);if(!n||!s)throw new Error(`No new element source found for ${t}`);k(n,s)}updateMain(e){const t=document.querySelector("main"),n=e.querySelector("main");if(!t||!n)throw new Error("No new main source found");k(t,n)}get selectedOption(){const e=this.querySelector("select option[selected], fieldset input:checked");if(e instanceof HTMLInputElement||e instanceof HTMLOptionElement)return e}get selectedOptionId(){const{selectedOption:e}=this;if(!e)return;const{optionValueId:t}=e.dataset;if(!t)throw new Error("No option value ID found");return t}get selectedOptionsValues(){return Array.from(this.querySelectorAll("select option[selected], fieldset input:checked")).map(t=>{const{optionValueId:n}=t.dataset;if(!n)throw new Error("No option value ID found");return n})}}f=new WeakMap,h=new WeakMap,I=new WeakMap,E=new WeakMap;customElements.get("variant-picker")||customElements.define("variant-picker",V);export{V};
