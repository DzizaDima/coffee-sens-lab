var k=Object.defineProperty;var q=e=>{throw TypeError(e)};var H=(e,n,t)=>n in e?k(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t;var v=(e,n,t)=>H(e,typeof n!="symbol"?n+"":n,t),w=(e,n,t)=>n.has(e)||q("Cannot "+t);var u=(e,n,t)=>(w(e,n,"read from private field"),t?t.call(e):n.get(e)),f=(e,n,t)=>n.has(e)?q("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(e):n.set(e,t);var h=(e,n,t)=>(w(e,n,"access private method"),t);import{C as A}from"./component.js";import{d as $,p as D,o as O,f as P,h as _}from"./utilities.js";import{m as g,s as L}from"./section-renderer.js";import{T as p,a as N,D as j}from"./events.js";import{c as T}from"./performance.js";import"./morph.js";var y,i,b,I,l,R,U,x,C;class B extends A{constructor(){super(...arguments);f(this,i);f(this,y,$(h(this,i,b),300).bind(this));v(this,"handleDiscountUpdate",t=>{u(this,l).call(this,t)});f(this,I,(t,r)=>{const o=this.refs.quantitySelectors[t-1]?.querySelector("input");if(!o)throw new Error("Quantity input not found");o.value=o.defaultValue;const s=this.refs[`cartItemError-${t}`],d=this.refs[`cartItemErrorContainer-${t}`];if(!(s instanceof HTMLElement))throw new Error("Cart item error not found");if(!(d instanceof HTMLElement))throw new Error("Cart item error container not found");s.textContent=r.errors,d.classList.remove("hidden")});f(this,l,t=>{if(t instanceof j){L.renderSection(this.sectionId,{cache:!1});return}if(t.target===this)return;const r=t.detail.data.sections?.[this.sectionId];r?(g(this.sectionId,r),h(this,i,C).call(this)):L.renderSection(this.sectionId,{cache:!1})})}connectedCallback(){super.connectedCallback(),document.addEventListener(p.cartUpdate,u(this,l)),document.addEventListener(p.discountUpdate,this.handleDiscountUpdate),document.addEventListener(p.quantitySelectorUpdate,u(this,y))}disconnectedCallback(){super.disconnectedCallback(),document.removeEventListener(p.cartUpdate,u(this,l)),document.removeEventListener(p.quantitySelectorUpdate,u(this,y))}onLineItemRemove(t){this.updateQuantity({line:t,quantity:0,action:"clear"});const r=this.refs.cartItemRows[t-1];if(!r)return;[r,...this.refs.cartItemRows.filter(o=>o.dataset.parentKey===r.dataset.key)].forEach(o=>{const s=()=>o.remove();if(D())return s();o.style.setProperty("--row-height",`${o.clientHeight}px`),o.classList.add("removing"),O(o,s)})}updateQuantity(t){const r=T.createStartingMarker(`${t.action}:user-action`);h(this,i,R).call(this);const{line:a,quantity:o}=t,{cartTotal:s}=this.refs,d=document.querySelectorAll("cart-items-component"),S=new Set([this.sectionId]);d.forEach(c=>{c instanceof HTMLElement&&c.dataset.sectionId&&S.add(c.dataset.sectionId)});const M=JSON.stringify({line:a,quantity:o,sections:Array.from(S).join(","),sections_url:window.location.pathname});s?.shimmer(),fetch(`${Theme.routes.cart_change_url}`,P("json",{body:M})).then(c=>c.text()).then(c=>{const m=JSON.parse(c);if(_(this),m.errors){u(this,I).call(this,a,m);return}const E=new DOMParser().parseFromString(m.sections[this.sectionId],"text/html").querySelector('[ref="cartItemCount"]')?.textContent,Q=E?parseInt(E,10):0;h(this,i,x).call(this,m),this.dispatchEvent(new N(m,this.sectionId,{itemCount:Q,source:"cart-items-component",sections:m.sections})),g(this.sectionId,m.sections[this.sectionId]),h(this,i,C).call(this)}).catch(c=>{console.error(c)}).finally(()=>{h(this,i,U).call(this),T.measureFromMarker(r)})}get sectionId(){const{sectionId:t}=this.dataset;if(!t)throw new Error("Section id missing");return t}}y=new WeakMap,i=new WeakSet,b=function(t){if(!(t.target instanceof Node)||!this.contains(t.target))return;const{quantity:r,cartLine:a}=t.detail;if(!a)return;if(r===0)return this.onLineItemRemove(a);this.updateQuantity({line:a,quantity:r,action:"change"});const o=this.refs.cartItemRows[a-1];if(!o)return;o.querySelector("text-component")?.shimmer()},I=new WeakMap,l=new WeakMap,R=function(){this.classList.add("cart-items-disabled")},U=function(){this.classList.remove("cart-items-disabled")},x=function(t){if(t.items)for(const r of t.items){const a=r.variant_id.toString(),o=document.querySelectorAll(`quantity-selector-component[data-variant-id="${a}"]`);for(const s of o){const d=s.querySelector("input[data-cart-quantity]");d&&(d.setAttribute("data-cart-quantity",r.quantity.toString()),"updateCartQuantity"in s&&typeof s.updateCartQuantity=="function"&&s.updateCartQuantity())}}},C=function(){for(const t of document.querySelectorAll("cart-quantity-selector-component"))t.updateButtonStates?.()};customElements.get("cart-items-component")||customElements.define("cart-items-component",B);
