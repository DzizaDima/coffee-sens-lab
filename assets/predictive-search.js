var N=Object.defineProperty;var D=s=>{throw TypeError(s)};var O=(s,o,e)=>o in s?N(s,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[o]=e;var y=(s,o,e)=>O(s,typeof o!="symbol"?o+"":o,e),E=(s,o,e)=>o.has(s)||D("Cannot "+e);var n=(s,o,e)=>(E(s,o,"read from private field"),e?e.call(s):o.get(s)),u=(s,o,e)=>o.has(s)?D("Cannot add the same private member more than once"):o instanceof WeakSet?o.add(s):o.set(s,e),a=(s,o,e,t)=>(E(s,o,"write to private field"),t?t.call(s,e):o.set(s,e),e),h=(s,o,e)=>(E(s,o,"access private method"),e);import{C as W}from"./component.js";import{n as j,p as $,o as z,d as V}from"./utilities.js";import{s as L}from"./section-renderer.js";import{m as H}from"./morph.js";import{R as M}from"./recently-viewed-products.js";import{a as G}from"./dialog.js";var w,g,b,I,S,r,d,f,v,p,x,_,U,B,K,A,P,m;class J extends W{constructor(){super(...arguments);u(this,r);y(this,"requiredRefs",["searchInput","predictiveSearchResults","resetButton"]);u(this,w,new AbortController);u(this,g,null);u(this,b,e=>{const t=e.target;!(t instanceof HTMLButtonElement||t instanceof HTMLAnchorElement||t instanceof HTMLInputElement||t.closest("button")||t.closest("a")||t.closest("input"))&&this.refs.searchInput&&this.refs.searchInput.focus()});u(this,I,e=>{e.metaKey&&e.key==="k"&&this.dialog?.toggleDialog()});u(this,S,()=>{n(this,m).call(this)});u(this,f,!1);y(this,"onSearchKeyDown",e=>{if(e.key==="Escape"){n(this,m).call(this);return}if(!n(this,r,d)?.length||e.key==="ArrowLeft"||e.key==="ArrowRight")return;const t=n(this,r,v),i=n(this,r,d).length;switch(e.key){case"ArrowDown":a(this,f,!0),e.preventDefault(),a(this,r,t<i-1?t+1:0,p);break;case"Tab":e.shiftKey?(a(this,f,!0),e.preventDefault(),a(this,r,t>0?t-1:i-1,p)):(a(this,f,!0),e.preventDefault(),a(this,r,t<i-1?t+1:0,p));break;case"ArrowUp":a(this,f,!0),e.preventDefault(),a(this,r,t>0?t-1:i-1,p);break;case"Enter":{const c=this.refs.predictiveSearchResults.querySelector("[data-single-result-url]");if(c instanceof HTMLElement&&c.dataset.singleResultUrl){e.preventDefault(),window.location.href=c.dataset.singleResultUrl;return}if(n(this,r,v)>=0)e.preventDefault(),n(this,r,x)?.querySelector("a")?.click();else{const l=new URL(Theme.routes.search_url,location.origin);l.searchParams.set("q",this.refs.searchInput.value),window.location.href=l.toString()}break}}});y(this,"resetSearch",V((e=!0)=>{e&&this.refs.searchInput.focus(),n(this,m).call(this)},100));y(this,"search",V(e=>{if(!e.inputType)return;const t=this.refs.searchInput.value.trim();if(a(this,r,-1,p),!t.length){n(this,m).call(this);return}h(this,r,A).call(this),h(this,r,U).call(this,t)},200));u(this,m,async()=>{const{predictiveSearchResults:e,searchInput:t}=this.refs,i="predictive-search-empty";a(this,r,-1,p),t.value="",h(this,r,K).call(this);const c=h(this,r,P).call(this),l=new URL(window.location.href);l.searchParams.delete("page");const F=await L.getSectionHTML(i,!1,l),R=new DOMParser().parseFromString(F,"text/html").querySelector(".predictive-search-empty-section");if(!R)throw new Error("No empty section markup found");if(M.getProducts().length>0){const T=await h(this,r,B).call(this);if(!T)return;const k=new DOMParser().parseFromString(T,"text/html").getElementById("predictive-search-products");if(!k)return;for(const q of k.children)q instanceof HTMLElement&&q.setAttribute("ref","recentlyViewedWrapper");const C=R.querySelector("#predictive-search-products");if(!C)return;C.prepend(...k.children)}c.signal.aborted||(H(e,R),h(this,r,_).call(this))})}get dialog(){return this.closest("dialog-component")}connectedCallback(){super.connectedCallback();const{dialog:e}=this,{signal:t}=n(this,w);this.refs.searchInput.value.length>0&&h(this,r,A).call(this),e&&(document.addEventListener("keydown",n(this,I),{signal:t}),e.addEventListener(G.eventName,n(this,S),{signal:t}),this.addEventListener("click",n(this,b),{signal:t})),j(()=>{this.resetSearch(!1)})}disconnectedCallback(){super.disconnectedCallback(),n(this,w).abort()}clearRecentlyViewedProducts(e){e.stopPropagation(),M.clearProducts();const{recentlyViewedItems:t,recentlyViewedTitle:i,recentlyViewedWrapper:c}=this.refs;[...t||[],...i||[]].length!==0&&c&&(c.classList.add("removing"),z(c,()=>{c.remove()}))}}w=new WeakMap,g=new WeakMap,b=new WeakMap,I=new WeakMap,S=new WeakMap,r=new WeakSet,d=function(){return Array.from(this.querySelectorAll(".predictive-search-results__wrapper-queries, .predictive-search-results__wrapper-products, .predictive-search-results__list")).flatMap(i=>i.classList.contains("predictive-search-results__wrapper-products")?Array.from(i.querySelectorAll(".predictive-search-results__card")):Array.from(i.querySelectorAll('[ref="resultsItems[]"], .predictive-search-results__card'))).filter(i=>i instanceof HTMLElement)},f=new WeakMap,v=function(){return n(this,r,d)?.findIndex(e=>e.getAttribute("aria-selected")==="true")??-1},p=function(e){if(n(this,r,d)?.length){n(this,r,d).forEach(t=>{t.classList.remove("keyboard-focus")});for(const[t,i]of n(this,r,d).entries())t===e?(i.setAttribute("aria-selected","true"),n(this,f)&&i.classList.add("keyboard-focus"),i.scrollIntoView({behavior:$()?"instant":"smooth",block:"nearest"})):i.removeAttribute("aria-selected");this.refs.searchInput.focus()}},x=function(){return n(this,r,d)?.[n(this,r,v)]},_=function(){requestAnimationFrame(()=>{const e=this.refs.predictiveSearchResults.querySelector(".predictive-search-results__inner");e instanceof HTMLElement&&(e.scrollTop=0);const t=this.querySelector(".predictive-search-form__content");t instanceof HTMLElement&&(t.scrollTop=0)})},U=async function(e){if(!this.dataset.sectionId)return;const t=new URL(Theme.routes.predictive_search_url,location.origin);t.searchParams.set("q",e),t.searchParams.set("resources[limit_scope]","each");const{predictiveSearchResults:i}=this.refs,c=h(this,r,P).call(this);L.getSectionHTML(this.dataset.sectionId,!1,t).then(l=>{l&&(c.signal.aborted||(H(i,l),h(this,r,_).call(this)))}).catch(l=>{if(!c.signal.aborted)throw l})},B=async function(){if(!this.dataset.sectionId)return null;const e=M.getProducts();if(e.length===0)return null;const t=new URL(Theme.routes.search_url,location.origin);return t.searchParams.set("q",e.map(i=>`id:${i}`).join(" OR ")),t.searchParams.set("resources[type]","product"),L.getSectionHTML(this.dataset.sectionId,!1,t)},K=function(){const{resetButton:e}=this.refs;e.hidden=!0},A=function(){const{resetButton:e}=this.refs;e.hidden=!1},P=function(){const e=new AbortController;return n(this,g)&&n(this,g).abort(),a(this,g,e),e},m=new WeakMap;customElements.get("predictive-search-component")||customElements.define("predictive-search-component",J);
