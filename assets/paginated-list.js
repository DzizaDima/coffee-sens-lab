var F=Object.defineProperty;var E=r=>{throw TypeError(r)};var I=(r,o,e)=>o in r?F(r,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[o]=e;var x=(r,o,e)=>I(r,typeof o!="symbol"?o+"":o,e),C=(r,o,e)=>o.has(r)||E("Cannot "+e);var l=(r,o,e)=>(C(r,o,"read from private field"),e?e.call(r):o.get(r)),w=(r,o,e)=>o.has(r)?E("Cannot add the same private member more than once"):o instanceof WeakSet?o.add(r):o.set(r,e),h=(r,o,e,t)=>(C(r,o,"write to private field"),t?t.call(r,e):o.set(r,e),e),n=(r,o,e)=>(C(r,o,"access private method"),e);import{C as N}from"./component.js";import{s as k}from"./section-renderer.js";import{r as M,v as O}from"./utilities.js";import{T}from"./events.js";import{P as q}from"./paginated-list-aspect-ratio.js";import"./morph.js";var u,f,v,s,L,P,g,H,R,U,y,m,b;class z extends N{constructor(){super(...arguments);w(this,s);x(this,"pages",new Map);x(this,"infinityScrollObserver");w(this,u,null);w(this,f,null);w(this,v);w(this,b,()=>{var a,c;this.pages.clear(),(a=l(this,u))==null||a.call(this),(c=l(this,f))==null||c.call(this),h(this,u,null),h(this,f,null);const e=this.refs.grid?.dataset.lastPage,t=new MutationObserver(()=>{if(this.refs.grid?.dataset.lastPage!==e){if(t.disconnect(),!this.isConnected)return;n(this,s,L).call(this),n(this,s,g).call(this,"next")}}),{grid:i}=this.refs;i&&(t.observe(i,{attributes:!0,attributeFilter:["data-last-page"],childList:!0}),setTimeout(()=>{t&&t.disconnect()},3e3))})}connectedCallback(){super.connectedCallback();const e=this.querySelector('[ref="cardGallery"]');e&&h(this,v,new q({templateCard:e})),n(this,s,g).call(this,"next"),n(this,s,g).call(this,"previous"),n(this,s,L).call(this),document.addEventListener(T.FilterUpdate,l(this,b))}disconnectedCallback(){super.disconnectedCallback(),this.infinityScrollObserver&&this.infinityScrollObserver.disconnect(),document.removeEventListener(T.FilterUpdate,l(this,b))}get sectionId(){const e=this.getAttribute("section-id");if(!e)throw new Error("The section-id attribute is required");return e}}u=new WeakMap,f=new WeakMap,v=new WeakMap,s=new WeakSet,L=function(){const{viewMorePrevious:e,viewMoreNext:t}=this.refs;!e&&!t||(this.infinityScrollObserver||(this.infinityScrollObserver=new IntersectionObserver(async i=>{O.current&&await O.current;for(const a of i)if(a.isIntersecting){const{viewMorePrevious:c,viewMoreNext:d}=this.refs;a.target===c?n(this,s,U).call(this):a.target===d&&n(this,s,R).call(this)}},{rootMargin:"100px"})),e&&this.infinityScrollObserver.observe(e),t&&this.infinityScrollObserver.observe(t))},P=function(e){if(!e)return!1;const{grid:t}=this.refs,i=t?.dataset.lastPage;return!(!i||e.page<1||e.page>Number(i))},g=async function(e){const t=n(this,s,y).call(this,e),i=()=>{var a,c;e==="next"?((a=l(this,u))==null||a.call(this),h(this,u,null)):((c=l(this,f))==null||c.call(this),h(this,f,null))};if(!t||!n(this,s,P).call(this,t)){i();return}await n(this,s,H).call(this,t.page,t.url),i()},H=async function(e,t=void 0){const i={page:e,url:t};if(!t){const c=new URL(window.location.href);c.searchParams.set("page",e.toString()),c.hash="",i.url=c}if(!n(this,s,P).call(this,i))return;const a=await k.getSectionHTML(this.sectionId,!0,i.url);this.pages.set(e,a)},R=async function(){const{grid:e}=this.refs;if(!e)return;const t=n(this,s,y).call(this,"next");if(!t||!n(this,s,P).call(this,t))return;let i=n(this,s,m).call(this,t.page);if(!i){const a=new Promise(c=>{h(this,u,c)});if(n(this,s,g).call(this,"next"),await a,i=n(this,s,m).call(this,t.page),!i)return}e.append(...i),l(this,v).processNewElements(),history.pushState("","",t.url.toString()),M(()=>{n(this,s,g).call(this,"next")})},U=async function(){const{grid:e}=this.refs;if(!e)return;const t=n(this,s,y).call(this,"previous");if(!t||!n(this,s,P).call(this,t))return;let i=n(this,s,m).call(this,t.page);if(!i){const p=new Promise(S=>{h(this,f,S)});if(n(this,s,g).call(this,"previous"),await p,i=n(this,s,m).call(this,t.page),!i)return}const a=window.scrollY,c=e.firstElementChild,d=c?c.getBoundingClientRect().top+window.scrollY:0;if(e.prepend(...i),l(this,v).processNewElements(),history.pushState("","",t.url.toString()),c){const S=c.getBoundingClientRect().top+window.scrollY-d;window.scrollTo({top:a+S,behavior:"instant"})}M(()=>{n(this,s,g).call(this,"previous")})},y=function(e){const{cards:t}=this.refs,i=e==="previous";if(!Array.isArray(t))return;const a=t[i?0:t.length-1];if(!a)return;const c=Number(a.dataset.page),d=i?c-1:c+1,p=new URL(window.location.href);return p.searchParams.set("page",d.toString()),p.hash="",{page:d,url:p}},m=function(e){const t=this.pages.get(e);if(!t)return;const a=new DOMParser().parseFromString(t,"text/html").querySelector('[ref="grid"]');if(a)return a.querySelectorAll(':scope > [ref="cards[]"]')},b=new WeakMap;export{z as P};
