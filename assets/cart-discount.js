var A=Object.defineProperty;var H=s=>{throw TypeError(s)};var P=(s,o,t)=>o in s?A(s,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[o]=t;var g=(s,o,t)=>P(s,typeof o!="symbol"?o+"":o,t),D=(s,o,t)=>o.has(s)||H("Cannot "+t);var y=(s,o,t)=>(D(s,o,"read from private field"),t?t.call(s):o.get(s)),C=(s,o,t)=>o.has(s)?H("Cannot add the same private member more than once"):o instanceof WeakSet?o.add(s):o.set(s,t),E=(s,o,t,n)=>(D(s,o,"write to private field"),n?n.call(s,t):o.set(s,t),t),f=(s,o,t)=>(D(s,o,"access private method"),t);import{C as q}from"./component.js";import{m as M}from"./section-renderer.js";import{D as T}from"./events.js";import{f as v}from"./utilities.js";import{c as F}from"./performance.js";import"./morph.js";var c,e,I,L,_;class O extends q{constructor(){super(...arguments);C(this,e);g(this,"requiredRefs",["cartDiscountError","cartDiscountErrorDiscountCode","cartDiscountErrorShipping"]);C(this,c,null);g(this,"applyDiscount",async t=>{const{cartDiscountError:n,cartDiscountErrorDiscountCode:i,cartDiscountErrorShipping:a}=this.refs;t.preventDefault(),t.stopPropagation();const d=t.target;if(!(d instanceof HTMLFormElement))return;const p=d.querySelector('input[name="discount"]');if(!(p instanceof HTMLInputElement)||typeof this.dataset.sectionId!="string")return;const u=p.value,b=f(this,e,I).call(this);try{const r=f(this,e,_).call(this);if(r.includes(u))return;n.classList.add("hidden"),i.classList.add("hidden"),a.classList.add("hidden");const x=v("json",{body:JSON.stringify({discount:[...r,u].join(","),sections:[this.dataset.sectionId]})}),m=await(await fetch(Theme.routes.cart_update_url,{...x,signal:b.signal})).json();if(m.discount_codes.find(h=>h.code===u&&h.applicable===!1)){p.value="",f(this,e,L).call(this,"discount_code");return}const S=m.sections[this.dataset.sectionId],w=new DOMParser().parseFromString(S,"text/html").getElementById(`shopify-section-${this.dataset.sectionId}`),j=w?.querySelectorAll(".cart-discount__pill")||[];if(w){const h=Array.from(j).map(l=>l instanceof HTMLLIElement?l.dataset.discountCode:null).filter(Boolean);if(h.length===r.length&&h.every(l=>r.includes(l))&&m.discount_codes.find(l=>l.code===u&&l.applicable===!0)){f(this,e,L).call(this,"shipping"),p.value="";return}}document.dispatchEvent(new T(m,this.id)),M(this.dataset.sectionId,S)}catch{}finally{E(this,c,null),F.measureFromEvent("discount-update:user-action",t)}});g(this,"removeDiscount",async t=>{if(t.preventDefault(),t.stopPropagation(),t instanceof KeyboardEvent&&t.key!=="Enter"||!(t instanceof MouseEvent)||!(t.target instanceof HTMLElement)||typeof this.dataset.sectionId!="string")return;const n=t.target.closest(".cart-discount__pill");if(!(n instanceof HTMLLIElement))return;const i=n.dataset.discountCode;if(!i)return;const a=f(this,e,_).call(this),d=a.indexOf(i);if(d===-1)return;a.splice(d,1);const p=f(this,e,I).call(this);try{const u=v("json",{body:JSON.stringify({discount:a.join(","),sections:[this.dataset.sectionId]})}),r=await(await fetch(Theme.routes.cart_update_url,{...u,signal:p.signal})).json();document.dispatchEvent(new T(r,this.id)),M(this.dataset.sectionId,r.sections[this.dataset.sectionId])}catch{}finally{E(this,c,null)}})}}c=new WeakMap,e=new WeakSet,I=function(){y(this,c)&&y(this,c).abort();const t=new AbortController;return E(this,c,t),t},L=function(t){const{cartDiscountError:n,cartDiscountErrorDiscountCode:i,cartDiscountErrorShipping:a}=this.refs,d=t==="discount_code"?i:a;n.classList.remove("hidden"),d.classList.remove("hidden")},_=function(){const t=[],n=this.querySelectorAll(".cart-discount__pill");for(const i of n)i instanceof HTMLLIElement&&typeof i.dataset.discountCode=="string"&&t.push(i.dataset.discountCode);return t};customElements.get("cart-discount-component")||customElements.define("cart-discount-component",O);
